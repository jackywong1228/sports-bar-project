<wxs src="./venue-booking.wxs" module="utils" />
<view class="container">
  <!-- TRIALä¼šå‘˜æç¤ºæ¨ªå¹… -->
  <view class="trial-banner" wx:if="{{!canBook && memberLevel === 'TRIAL'}}">
    <view class="trial-banner-content">
      <text class="trial-icon">&#x26A0;</text>
      <text class="trial-text">ä½“éªŒä¼šå‘˜æ— æ³•è‡ªè¡Œé¢„çº¦ï¼Œè¯·è”ç³»å‰å°æˆ–</text>
      <text class="trial-link" bindtap="goToMember">å‡çº§ä¼šå‘˜</text>
    </view>
  </view>

  <!-- é¢åº¦æç¤º -->
  <view class="quota-banner" wx:if="{{canBook && remainingQuota > 0}}">
    <text class="quota-text">ä»Šæ—¥å‰©ä½™é¢„çº¦é¢åº¦ï¼š{{remainingQuota}}å°æ—¶</text>
  </view>

  <!-- åœºé¦†ç±»å‹é€‰æ‹© - å¡ç‰‡å¼è®¾è®¡ -->
  <scroll-view class="type-cards-scroll" scroll-x enhanced show-scrollbar="{{false}}">
    <view class="type-cards">
      <view
        class="type-card {{currentTypeId === item.id ? 'active' : ''}}"
        wx:for="{{venueTypes}}"
        wx:key="id"
        bindtap="selectType"
        data-id="{{item.id}}"
      >
        <view class="type-card-icon">
          <text class="type-icon-text">{{item.icon || 'ğŸ€'}}</text>
        </view>
        <text class="type-card-name">{{item.name}}</text>
        <text class="type-card-count" wx:if="{{item.venue_count}}">{{item.venue_count}}ä¸ªåœºåœ°</text>
      </view>
    </view>
  </scroll-view>

  <!-- æ—¥æœŸé€‰æ‹© -->
  <scroll-view class="date-scroll" scroll-x enable-flex>
    <view
      class="date-item {{selectedDate === item.date ? 'active' : ''}}"
      wx:for="{{dates}}"
      wx:key="date"
      bindtap="selectDate"
      data-date="{{item.date}}"
    >
      <text class="date-week">{{item.weekDay}}</text>
      <text class="date-day">{{item.day}}</text>
    </view>
  </scroll-view>

  <!-- é¢„çº¦æ—¥å† -->
  <view class="calendar-wrapper" wx:if="{{!loading && calendarData.venues.length > 0}}">
    <!-- è¡¨å¤´ï¼šåœºé¦†åç§° -->
    <view class="calendar-header">
      <view class="time-column-header">æ—¶é—´</view>
      <scroll-view class="venues-header-scroll" scroll-x scroll-with-animation scroll-left="{{scrollLeft}}" bindscroll="onCalendarScroll">
        <view class="venues-header">
          <view class="venue-header-item" wx:for="{{calendarData.venues}}" wx:key="id">
            <text class="venue-name">{{item.name}}</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- æ—¶é—´æ®µå’Œé¢„çº¦æ ¼å­ -->
    <scroll-view class="calendar-body" scroll-y style="height: {{calendarHeight}}px;">
      <view class="calendar-row" wx:for="{{calendarData.time_slots}}" wx:key="hour" wx:for-item="timeSlot" wx:for-index="slotIndex">
        <!-- æ—¶é—´åˆ— -->
        <view class="time-column">{{timeSlot.label}}</view>
        <!-- åœºé¦†é¢„çº¦æ ¼å­ -->
        <scroll-view class="slots-scroll" scroll-x scroll-with-animation scroll-left="{{scrollLeft}}">
          <view class="slots-row">
            <view
              class="slot-cell {{venue.slots[slotIndex].status}} {{utils.isSlotSelected(selectedVenueId, selectedSlots, venue.id, timeSlot.hour) ? 'selected' : ''}}"
              wx:for="{{calendarData.venues}}"
              wx:key="id"
              wx:for-item="venue"
              wx:for-index="venueIndex"
              bindtap="selectSlot"
              data-venue-id="{{venue.id}}"
              data-venue-name="{{venue.name}}"
              data-venue-price="{{venue.price}}"
              data-hour="{{timeSlot.hour}}"
            >
              <text wx:if="{{venue.slots[slotIndex].status === 'reserved'}}">å·²çº¦</text>
              <text wx:else>å¯çº¦</text>
            </view>
          </view>
        </scroll-view>
      </view>
    </scroll-view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && calendarData.venues.length === 0}}">
    <image src="/assets/images/empty.png" mode="aspectFit"></image>
    <text>æš‚æ— å¯é¢„çº¦åœºé¦†</text>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å›¾ä¾‹è¯´æ˜ -->
  <view class="legend" wx:if="{{!loading && calendarData.venues.length > 0}}">
    <view class="legend-item">
      <view class="legend-dot available"></view>
      <text>å¯é¢„çº¦</text>
    </view>
    <view class="legend-item">
      <view class="legend-dot reserved"></view>
      <text>å·²é¢„çº¦</text>
    </view>
    <view class="legend-item">
      <view class="legend-dot selected"></view>
      <text>å·²é€‰æ‹©</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{selectedSlots.length > 0}}">
    <view class="booking-summary">
      <view class="summary-row">
        <text class="summary-label">å·²é€‰ï¼š</text>
        <text class="summary-value">{{selectedVenueName}} {{selectedSlots.length}}å°æ—¶</text>
      </view>
      <view class="summary-row">
        <text class="summary-label">æ—¶æ®µï¼š</text>
        <text class="summary-time">{{utils.getTimeRange(selectedSlots)}}</text>
      </view>
      <view class="summary-row" wx:if="{{remainingQuota >= 0}}">
        <text class="summary-label">å‰©ä½™é¢åº¦ï¼š</text>
        <text class="summary-quota">{{remainingQuota}}å°æ—¶</text>
      </view>
    </view>
    <button
      class="btn-submit"
      bindtap="submitBooking"
      loading="{{submitting}}"
      disabled="{{submitting || !canBook}}"
    >
      ç¡®è®¤é¢„çº¦
    </button>
  </view>

  <!-- åº•éƒ¨å ä½ -->
  <view class="bottom-placeholder" wx:if="{{selectedSlots.length > 0}}"></view>
</view>
