# 会员制度文档

本文档详细说明场馆体育社交系统的会员制度，包括会员等级、预约权限、折扣规则和违约处罚机制。

---

## 会员等级体系

### 等级概览

系统采用四级会员等级体系，等级从低到高依次为：

| 等级代码 | 等级名称 | 获取方式 | 有效期 |
|---------|---------|---------|--------|
| TRIAL | 试用会员 | 新用户注册自动获得 | 7天 |
| S | 普通会员 | 购买 S 级会员卡 | 按购买时长 |
| SS | 高级会员 | 购买 SS 级会员卡 | 按购买时长 |
| SSS | 尊享会员 | 购买 SSS 级会员卡 | 按购买时长 |

### 等级权益对比

| 权益项目 | TRIAL | S | SS | SSS |
|---------|-------|---|----|----|
| 提前预约天数 | 1天 | 3天 | 7天 | 14天 |
| 每日预约次数 | 1次 | 2次 | 3次 | 无限制 |
| 同时预约数量 | 1个 | 2个 | 3个 | 5个 |
| 餐食折扣 | 无 | 9.5折 | 9折 | 8.5折 |
| 积分倍率 | 1倍 | 1.2倍 | 1.5倍 | 2倍 |
| 专属客服 | 无 | 无 | 有 | 有 |
| 优先预约 | 无 | 无 | 无 | 有 |
| 专属活动 | 无 | 部分 | 大部分 | 全部 |

---

## 预约规则

### 预约权限配置

不同会员等级的预约权限详细配置如下：

#### TRIAL（试用会员）
```
提前预约天数: 1天
每日预约次数: 1次
同时预约数量: 1个
```
- 只能预约明天及以前的时段
- 每天最多创建 1 个预约
- 同一时间只能有 1 个未完成的预约

#### S（普通会员）
```
提前预约天数: 3天
每日预约次数: 2次
同时预约数量: 2个
```
- 可预约未来 3 天内的时段
- 每天最多创建 2 个预约
- 同一时间最多有 2 个未完成的预约

#### SS（高级会员）
```
提前预约天数: 7天
每日预约次数: 3次
同时预约数量: 3个
```
- 可预约未来 7 天内的时段
- 每天最多创建 3 个预约
- 同一时间最多有 3 个未完成的预约

#### SSS（尊享会员）
```
提前预约天数: 14天
每日预约次数: 无限制
同时预约数量: 5个
```
- 可预约未来 14 天内的时段
- 每天预约次数不限
- 同一时间最多有 5 个未完成的预约

### 预约流程

```
1. 选择场地/教练
      ↓
2. 检查预约权限（调用 GET /member/booking-permission）
      ↓
3. 选择日期和时段
      ↓
4. 确认预约信息
      ↓
5. 提交预约（调用 POST /member/reservations）
      ↓
6. 支付（如需）
      ↓
7. 预约成功，获取预约码
      ↓
8. 到场核销（调用 POST /member/reservations/{id}/verify）
```

### 预约状态说明

| 状态 | 说明 |
|------|------|
| pending | 待确认（等待场馆/教练确认） |
| confirmed | 已确认（可以使用） |
| cancelled | 已取消 |
| completed | 已完成（已核销使用） |
| no_show | 爽约（未到场） |

---

## 餐食折扣规则

### 折扣配置

| 会员等级 | 折扣率 | 优惠说明 |
|---------|--------|---------|
| TRIAL | 1.00（无折扣） | 原价消费 |
| S | 0.95（9.5折） | 节省 5% |
| SS | 0.90（9折） | 节省 10% |
| SSS | 0.85（8.5折） | 节省 15% |

### 折扣计算示例

假设原价为 100 元：

| 会员等级 | 原价 | 折扣率 | 折后价 | 节省金额 |
|---------|------|--------|--------|---------|
| TRIAL | 100.00 | 1.00 | 100.00 | 0.00 |
| S | 100.00 | 0.95 | 95.00 | 5.00 |
| SS | 100.00 | 0.90 | 90.00 | 10.00 |
| SSS | 100.00 | 0.85 | 85.00 | 15.00 |

### 折扣使用规则

1. **自动应用**：结算时系统自动计算折扣
2. **实时等级**：以下单时的会员等级为准
3. **不可叠加**：会员折扣与优惠券不可叠加，取优惠力度较大者
4. **适用范围**：仅适用于餐饮消费，不适用于场地预约费用

### 查询折扣接口

调用 `GET /member/food-discount` 可获取当前会员的折扣信息：

```json
// 请求
GET /api/v1/member/food-discount
Authorization: Bearer {token}

// 响应
{
  "code": 200,
  "data": {
    "level": "SS",
    "level_name": "高级会员",
    "discount_rate": 0.9,
    "discount_percent": 10,
    "original_price": 100.00,
    "discounted_price": 90.00
  }
}
```

---

## 违约处罚规则

### 违约类型

| 违约类型 | 代码 | 扣分 | 触发条件 |
|---------|------|------|---------|
| 爽约 | no_show | 10分 | 预约时间开始后 30 分钟内未到场且未取消 |
| 迟到取消 | late_cancel | 5分 | 预约开始前 2 小时内取消 |
| 正常取消 | normal_cancel | 0分 | 预约开始前 2 小时外取消（不扣分） |

### 处罚规则

| 累计违约积分 | 处罚措施 | 限制时长 |
|-------------|---------|---------|
| 0-19分 | 无处罚 | - |
| 20-49分 | 限制预约功能 | 7天 |
| 50分及以上 | 限制预约功能 | 30天 |

### 积分重置

- **自动重置**：每月 1 日 00:00 自动将违约积分清零
- **申诉通道**：如有特殊情况（如不可抗力），可联系客服申诉

### 违约记录查询

调用 `GET /member/violations` 可查询违约记录：

```json
// 请求
GET /api/v1/member/violations?page=1&page_size=20
Authorization: Bearer {token}

// 响应
{
  "code": 200,
  "data": {
    "total_points": 15,
    "is_restricted": false,
    "restriction_end_date": null,
    "records": [
      {
        "id": 1,
        "type": "no_show",
        "type_name": "爽约",
        "points": 10,
        "reservation_id": 123,
        "venue_name": "羽毛球场1号",
        "reservation_date": "2026-01-20",
        "reservation_time": "10:00-11:00",
        "created_at": "2026-01-20T11:00:00",
        "remark": "预约时间开始后未到场"
      },
      {
        "id": 2,
        "type": "late_cancel",
        "type_name": "迟到取消",
        "points": 5,
        "reservation_id": 124,
        "venue_name": "篮球场2号",
        "reservation_date": "2026-01-22",
        "reservation_time": "14:00-15:00",
        "created_at": "2026-01-22T13:30:00",
        "remark": "预约开始前1小时取消"
      }
    ],
    "total": 2,
    "page": 1,
    "page_size": 20
  }
}
```

---

## 预约核销

### 核销方式

1. **扫码核销**：会员出示预约码，工作人员扫码核销
2. **手动核销**：工作人员在管理后台手动核销

### 核销时间窗口

- **开始核销**：预约开始时间前 15 分钟
- **截止核销**：预约开始时间后 30 分钟
- 超过截止时间未核销，系统自动判定为爽约

### 核销接口

调用 `POST /member/reservations/{id}/verify` 进行核销：

```json
// 请求
POST /api/v1/member/reservations/123/verify
Authorization: Bearer {token}

// 响应（成功）
{
  "code": 200,
  "message": "核销成功",
  "data": {
    "reservation_id": 123,
    "member_name": "张三",
    "venue_name": "羽毛球场1号",
    "date": "2026-01-28",
    "start_time": "10:00",
    "end_time": "11:00",
    "verified_at": "2026-01-28T10:05:00"
  }
}

// 响应（失败 - 未到核销时间）
{
  "code": 400,
  "message": "未到核销时间，请在预约开始前15分钟内核销",
  "data": null
}

// 响应（失败 - 已过核销时间）
{
  "code": 400,
  "message": "已超过核销时间，该预约已自动标记为爽约",
  "data": null
}
```

---

## 常见问题

### Q1: 如何升级会员等级？
A: 在小程序「我的」->「会员中心」中购买更高级别的会员卡即可升级。

### Q2: 会员等级可以降级吗？
A: 会员卡到期后，如不续费将恢复为 TRIAL 等级。

### Q3: 违约积分什么时候清零？
A: 每月 1 日 00:00 自动清零。

### Q4: 被限制预约后如何解除？
A: 等待限制期满自动解除，或联系客服申诉。

### Q5: 优惠券和会员折扣可以叠加吗？
A: 不可叠加，系统会自动选择优惠力度更大的方案。

### Q6: 预约后临时有事无法到场怎么办？
A: 请尽早取消预约。预约开始前 2 小时外取消不扣分，2 小时内取消扣 5 分。

---

## 相关 API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/member/booking-permission` | GET | 检查预约权限 |
| `/member/food-discount` | GET | 获取餐食折扣信息 |
| `/member/violations` | GET | 获取违约记录 |
| `/member/reservations/{id}/verify` | POST | 预约核销 |
| `/member/reservations` | POST | 创建预约 |
| `/member/reservations/{id}/cancel` | PUT | 取消预约 |

详细接口文档请参考：[API 文档](api.md)
